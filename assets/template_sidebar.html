<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{TITLE}}</title>
    <link rel="stylesheet" href="/assets/github.css">
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --sidebar-width: 260px;
            --sidebar-bg: var(--color-canvas-subtle, #f6f8fa);
            --sidebar-border: var(--color-border-default, #d0d7de);
            --sidebar-header-bg: var(--color-canvas-default, #ffffff);
            --text-primary: var(--color-fg-default, #24292f);
            --text-secondary: var(--color-fg-muted, #57606a);
            --text-muted: var(--color-fg-subtle, #8b949e);
            --accent-color: var(--color-accent-fg, #0969da);
            --accent-bg: var(--color-accent-subtle, #ddf4ff);
            --hover-bg: var(--color-canvas-inset, #eaeef2);
            --content-bg: var(--color-canvas-default, #ffffff);
            --transition-speed: 0.2s;
        }

        * {
            box-sizing: border-box;
        }
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--content-bg);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 1000;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: var(--sidebar-bg);
            border: 1px solid var(--sidebar-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-speed) ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sidebar-toggle:hover {
            background: var(--hover-bg);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .sidebar-toggle svg {
            width: 18px;
            height: 18px;
            fill: var(--text-secondary);
            transition: transform var(--transition-speed) ease;
        }
        .sidebar-collapsed .sidebar-toggle {
            left: 12px;
        }
        .sidebar-collapsed .sidebar-toggle svg {
            transform: rotate(180deg);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 12px;
            right: 12px;
            z-index: 1000;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            background: var(--sidebar-bg);
            border: 1px solid var(--sidebar-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .theme-toggle svg {
            width: 18px;
            height: 18px;
            stroke: var(--text-secondary);
            fill: none;
            transition: stroke 0.3s ease;
        }
        .theme-toggle:hover svg {
            stroke: var(--accent-color);
        }
        .theme-toggle .icon-sun {
            display: none;
        }
        .theme-toggle .icon-moon {
            display: block;
        }
        [data-theme="dark"] .theme-toggle .icon-sun {
            display: block;
        }
        [data-theme="dark"] .theme-toggle .icon-moon {
            display: none;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            min-width: 200px;
            max-width: 400px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--sidebar-border);
            overflow-y: auto;
            overflow-x: hidden;
            flex-shrink: 0;
            transition: width var(--transition-speed) ease,
                        min-width var(--transition-speed) ease,
                        opacity var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
        }
        .sidebar-collapsed .sidebar {
            width: 0;
            min-width: 0;
            opacity: 0;
            border-right: none;
        }

        /* Sidebar Header */
        .sidebar-header {
            padding: 16px;
            padding-left: 56px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            background: var(--sidebar-header-bg);
            border-bottom: 1px solid var(--sidebar-border);
            display: flex;
            align-items: center;
            gap: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .sidebar-header-icon {
            font-size: 16px;
        }

        /* Sidebar Content */
        .sidebar-content {
            padding: 8px 0;
            flex: 1;
        }

        /* Folder */
        .sidebar-folder {
            user-select: none;
        }
        .sidebar-folder-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            border-radius: 6px;
            margin: 2px 8px;
            transition: background var(--transition-speed) ease;
        }
        .sidebar-folder-header:hover {
            background: var(--hover-bg);
        }
        .sidebar-folder-icon {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            transition: transform var(--transition-speed) ease;
            fill: var(--text-muted);
        }
        .sidebar-folder.collapsed .sidebar-folder-icon {
            transform: rotate(-90deg);
        }
        .sidebar-folder-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .sidebar-folder-items {
            overflow: hidden;
            transition: max-height 0.3s ease;
            max-height: 1000px;
        }
        .sidebar-folder.collapsed .sidebar-folder-items {
            max-height: 0;
        }

        /* File Item */
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 8px 12px 8px 32px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            cursor: pointer;
            border-radius: 6px;
            margin: 2px 8px;
            transition: all var(--transition-speed) ease;
            border-left: 2px solid transparent;
        }
        .sidebar-item:hover {
            background: var(--hover-bg);
        }
        .sidebar-item.active {
            background: var(--accent-bg);
            border-left-color: var(--accent-color);
            color: var(--accent-color);
            font-weight: 500;
        }
        .sidebar-item-icon {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            fill: var(--text-muted);
            flex-shrink: 0;
        }
        .sidebar-item.active .sidebar-item-icon {
            fill: var(--accent-color);
        }
        .sidebar-item-name {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* Root level items (no folder) */
        .sidebar-item.root-item {
            padding-left: 12px;
        }

        /* Resizer */
        .resizer {
            width: 4px;
            background: transparent;
            cursor: col-resize;
            flex-shrink: 0;
            transition: background var(--transition-speed) ease;
        }
        .resizer:hover {
            background: var(--accent-color);
        }
        .sidebar-collapsed .resizer {
            display: none;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px 48px;
            padding-top: 60px;
            background: var(--content-bg);
            transition: padding var(--transition-speed) ease;
            display: flex;
            justify-content: center;
        }
        .sidebar-collapsed .main-content {
            padding-left: 48px;
        }
        .markdown-body {
            max-width: 980px;
            width: 100%;
        }

        /* Reload Indicator */
        .reload-indicator {
            position: fixed;
            top: 12px;
            right: 60px;
            padding: 8px 16px;
            background: var(--color-success-fg, #2ea043);
            color: white;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 9999;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .reload-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }
        .reload-indicator.disconnected {
            background: var(--color-danger-fg, #cf222e);
        }

        /* Scrollbar styling */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        .sidebar::-webkit-scrollbar-thumb {
            background: var(--sidebar-border);
            border-radius: 3px;
        }
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>
<body>
    <div id="reload-indicator" class="reload-indicator">Connected</div>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
        <svg viewBox="0 0 16 16">
            <path d="M1 2.75A.75.75 0 0 1 1.75 2h12.5a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 2.75Zm0 5A.75.75 0 0 1 1.75 7h12.5a.75.75 0 0 1 0 1.5H1.75A.75.75 0 0 1 1 7.75ZM1.75 12h12.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Z"/>
        </svg>
    </button>

    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" title="Toggle theme">
        <svg class="icon-moon" viewBox="0 0 24 24" stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <svg class="icon-sun" viewBox="0 0 24 24" stroke-width="2">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </button>

    <div class="container" id="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <span class="sidebar-header-icon">ðŸ“‚</span>
                <span>{{TITLE}}</span>
            </div>
            <div class="sidebar-content">
                {{SIDEBAR}}
            </div>
        </div>
        <div class="resizer" id="resizer"></div>
        <div class="main-content">
            <div class="markdown-body" id="content">
                {{CONTENT}}
            </div>
        </div>
    </div>

    <script>
        // Theme Management
        (function() {
            const themeToggle = document.getElementById('themeToggle');
            const hljsTheme = document.getElementById('hljs-theme');

            const HLJS_LIGHT = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css';
            const HLJS_DARK = 'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css';

            // Get current theme
            function getCurrentTheme() {
                const saved = localStorage.getItem('theme');
                if (saved) return saved;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            // Apply theme
            function applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                hljsTheme.href = theme === 'dark' ? HLJS_DARK : HLJS_LIGHT;
                localStorage.setItem('theme', theme);
            }

            // Initialize theme
            applyTheme(getCurrentTheme());

            // Toggle theme
            themeToggle.addEventListener('click', () => {
                const current = getCurrentTheme();
                const next = current === 'dark' ? 'light' : 'dark';
                applyTheme(next);
            });

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        })();

        hljs.highlightAll();

        // SVG Icons
        const icons = {
            file: '<svg class="sidebar-item-icon" viewBox="0 0 16 16"><path d="M2 1.75C2 .784 2.784 0 3.75 0h6.586c.464 0 .909.184 1.237.513l2.914 2.914c.329.328.513.773.513 1.237v9.586A1.75 1.75 0 0 1 13.25 16h-9.5A1.75 1.75 0 0 1 2 14.25Zm1.75-.25a.25.25 0 0 0-.25.25v12.5c0 .138.112.25.25.25h9.5a.25.25 0 0 0 .25-.25V6h-2.75A1.75 1.75 0 0 1 9 4.25V1.5Zm6.75.062V4.25c0 .138.112.25.25.25h2.688l-.011-.013-2.914-2.914-.013-.011Z"/></svg>',
            chevron: '<svg class="sidebar-folder-icon" viewBox="0 0 16 16"><path d="M12.78 5.22a.749.749 0 0 1 0 1.06l-4.25 4.25a.749.749 0 0 1-1.06 0L3.22 6.28a.749.749 0 1 1 1.06-1.06L8 8.939l3.72-3.719a.749.749 0 0 1 1.06 0Z"/></svg>'
        };

        // State
        let currentFile = null;
        let sidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        let collapsedFolders = JSON.parse(localStorage.getItem('collapsedFolders') || '{}');

        // Initialize
        function init() {
            // Apply saved sidebar state
            if (sidebarCollapsed) {
                document.getElementById('container').classList.add('sidebar-collapsed');
            }

            // Apply saved folder states
            document.querySelectorAll('.sidebar-folder').forEach(folder => {
                const folderId = folder.dataset.folder;
                if (collapsedFolders[folderId]) {
                    folder.classList.add('collapsed');
                }
            });

            // Initialize current file from URL
            const urlParams = new URLSearchParams(window.location.search);
            currentFile = urlParams.get('file');
        }

        // Toggle sidebar
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            const container = document.getElementById('container');
            container.classList.toggle('sidebar-collapsed');
            sidebarCollapsed = container.classList.contains('sidebar-collapsed');
            localStorage.setItem('sidebarCollapsed', sidebarCollapsed);
        });

        // Toggle folder
        function toggleFolder(folderId) {
            const folder = document.querySelector(`[data-folder="${folderId}"]`);
            if (folder) {
                folder.classList.toggle('collapsed');
                collapsedFolders[folderId] = folder.classList.contains('collapsed');
                localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
            }
        }

        // Load file via AJAX
        async function loadFile(path) {
            try {
                const response = await fetch('/api/content?file=' + encodeURIComponent(path));
                if (!response.ok) throw new Error('File not found');

                const html = await response.text();
                document.getElementById('content').innerHTML = html;

                // Update active state in sidebar
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.path === path);
                });

                // Expand parent folder if file is in a subfolder
                expandParentFolder(path);

                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('file', path);
                history.pushState({file: path}, '', url);

                // Update current file
                currentFile = path;

                // Re-highlight code blocks
                hljs.highlightAll();
            } catch (e) {
                console.error('Failed to load file:', e);
            }
        }

        // Update sidebar from API
        async function updateSidebar() {
            try {
                const response = await fetch('/api/files');
                if (!response.ok) throw new Error('Failed to fetch files');

                const data = await response.json();
                const sidebarContent = document.querySelector('.sidebar-content');

                // Group files by directory
                const dirs = {};
                data.files.forEach(file => {
                    const lastSlash = file.path.lastIndexOf('/');
                    const dir = lastSlash === -1 ? '' : file.path.substring(0, lastSlash);
                    if (!dirs[dir]) dirs[dir] = [];
                    dirs[dir].push(file);
                });

                // Build sidebar HTML
                let html = '';
                const sortedDirs = Object.keys(dirs).sort();

                sortedDirs.forEach(dir => {
                    const files = dirs[dir];
                    if (dir === '') {
                        // Root level files
                        files.forEach(file => {
                            const isActive = file.path === currentFile;
                            html += `<a href="javascript:void(0)" class="sidebar-item root-item${isActive ? ' active' : ''}" data-path="${escapeHtml(file.path)}" onclick="loadFile('${escapeHtml(file.path)}')">${icons.file}<span class="sidebar-item-name">${escapeHtml(file.name)}</span></a>`;
                        });
                    } else {
                        // Files in a folder
                        const folderId = dir.replace(/\//g, '_').replace(/\\/g, '_');
                        const isCollapsed = collapsedFolders[folderId] ? ' collapsed' : '';
                        html += `<div class="sidebar-folder${isCollapsed}" data-folder="${escapeHtml(folderId)}">
                            <div class="sidebar-folder-header" onclick="toggleFolder('${escapeHtml(folderId)}')">
                                ${icons.chevron}
                                <span class="sidebar-folder-name">${escapeHtml(dir)}</span>
                            </div>
                            <div class="sidebar-folder-items">`;
                        files.forEach(file => {
                            const isActive = file.path === currentFile;
                            html += `<a href="javascript:void(0)" class="sidebar-item${isActive ? ' active' : ''}" data-path="${escapeHtml(file.path)}" onclick="loadFile('${escapeHtml(file.path)}')">${icons.file}<span class="sidebar-item-name">${escapeHtml(file.name)}</span></a>`;
                        });
                        html += '</div></div>';
                    }
                });

                sidebarContent.innerHTML = html;
            } catch (e) {
                console.error('Failed to update sidebar:', e);
            }
        }

        // HTML escape helper
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Expand the parent folder of a file path
        function expandParentFolder(path) {
            // Get the directory part of the path
            const lastSlash = path.lastIndexOf('/');
            if (lastSlash === -1) return; // Root level file, no folder to expand

            const dir = path.substring(0, lastSlash);
            const folderId = dir.replace(/\//g, '_').replace(/\\/g, '_');

            const folder = document.querySelector(`[data-folder="${folderId}"]`);
            if (folder && folder.classList.contains('collapsed')) {
                folder.classList.remove('collapsed');
                collapsedFolders[folderId] = false;
                localStorage.setItem('collapsedFolders', JSON.stringify(collapsedFolders));
            }
        }

        // Handle browser back/forward
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.file) {
                loadFile(event.state.file);
            }
        });

        // Resizer functionality
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const newWidth = e.clientX;
            if (newWidth >= 200 && newWidth <= 500) {
                sidebar.style.width = newWidth + 'px';
                document.documentElement.style.setProperty('--sidebar-width', newWidth + 'px');
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                localStorage.setItem('sidebarWidth', sidebar.style.width);
            }
        });

        // Restore sidebar width
        const savedWidth = localStorage.getItem('sidebarWidth');
        if (savedWidth) {
            sidebar.style.width = savedWidth;
        }

        // WebSocket for live reload
        (function() {
            const indicator = document.getElementById('reload-indicator');
            let ws;
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 10;

            function showIndicator(message, isError) {
                indicator.textContent = message;
                indicator.classList.toggle('disconnected', isError);
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            function connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws`;
                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    reconnectAttempts = 0;
                    showIndicator('Connected', false);
                };

                ws.onmessage = function(event) {
                    if (event.data === 'reload') {
                        showIndicator('Reloading...', false);
                        if (currentFile) {
                            loadFile(currentFile);
                        } else {
                            window.location.reload();
                        }
                    } else if (event.data === 'tree-update') {
                        showIndicator('Updating sidebar...', false);
                        updateSidebar();
                    }
                };

                ws.onclose = function() {
                    if (reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        showIndicator(`Reconnecting (${reconnectAttempts})...`, true);
                        setTimeout(connect, 1000 * Math.min(reconnectAttempts, 5));
                    } else {
                        showIndicator('Disconnected', true);
                    }
                };

                ws.onerror = function() {
                    ws.close();
                };
            }

            connect();
        })();

        // Initialize on load
        init();
    </script>
</body>
</html>
